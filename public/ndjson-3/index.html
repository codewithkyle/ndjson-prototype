<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDJSON Prototype</title>
    <link href="/brixi.css" rel="stylesheet">
    <style>
        .spin{
            animation: spin 300ms linear infinite;
        }
        @keyframes spin{
            from{
                transform: rotate(0deg);
            }
            to{
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-grey-200 w-screen h-screen m-0" flex="items-center justify-center" style="overflow-x: hidden;">
    <div class="status-tracker" style="position: fixed;top: 1rem;right: 1rem;">
        <p class="download-tracker m-0 bg-white p-1 radius-0.5 border-1 border-solid border-grey-500 shadow-sm text-center line-normal mb-1" style="display: none;align-items: center;width: 235px;">
            <i class="font-grey-700 spin" style="width: 36px;height: 36px;" flex="items-center justify-center">
                <svg style="width: 24px;height: 24px;" aria-hidden="true" focusable="false" data-prefix="fad" data-icon="spinner-third" class="svg-inline--fa fa-spinner-third fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g class="fa-group"><path class="fa-secondary" fill="currentColor" d="M478.71 364.58zm-22 6.11l-27.83-15.9a15.92 15.92 0 0 1-6.94-19.2A184 184 0 1 1 256 72c5.89 0 11.71.29 17.46.83-.74-.07-1.48-.15-2.23-.21-8.49-.69-15.23-7.31-15.23-15.83v-32a16 16 0 0 1 15.34-16C266.24 8.46 261.18 8 256 8 119 8 8 119 8 256s111 248 248 248c98 0 182.42-56.95 222.71-139.42-4.13 7.86-14.23 10.55-22 6.11z" opacity="0.4"></path><path class="fa-primary" fill="currentColor" d="M271.23 72.62c-8.49-.69-15.23-7.31-15.23-15.83V24.73c0-9.11 7.67-16.78 16.77-16.17C401.92 17.18 504 124.67 504 256a246 246 0 0 1-25 108.24c-4 8.17-14.37 11-22.26 6.45l-27.84-15.9c-7.41-4.23-9.83-13.35-6.2-21.07A182.53 182.53 0 0 0 440 256c0-96.49-74.27-175.63-168.77-183.38z"></path></g></svg>
            </i>
            <span class="inline-block ml-0.5 mr-0.25">Downloading cards</span>
            (<span class="download-progress inline-block font-success-700">0%</span>)
        </p>
        <p class="unpack-tracker m-0 bg-white p-1 radius-0.5 border-1 border-solid border-grey-500 shadow-sm text-center line-normal" style="display: none;align-items: center;width: 235px;">
            <i class="font-grey-700 spin" style="width: 36px;height: 36px;" flex="items-center justify-center">
                <svg style="width: 24px;height: 24px;" aria-hidden="true" focusable="false" data-prefix="fad" data-icon="spinner-third" class="svg-inline--fa fa-spinner-third fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g class="fa-group"><path class="fa-secondary" fill="currentColor" d="M478.71 364.58zm-22 6.11l-27.83-15.9a15.92 15.92 0 0 1-6.94-19.2A184 184 0 1 1 256 72c5.89 0 11.71.29 17.46.83-.74-.07-1.48-.15-2.23-.21-8.49-.69-15.23-7.31-15.23-15.83v-32a16 16 0 0 1 15.34-16C266.24 8.46 261.18 8 256 8 119 8 8 119 8 256s111 248 248 248c98 0 182.42-56.95 222.71-139.42-4.13 7.86-14.23 10.55-22 6.11z" opacity="0.4"></path><path class="fa-primary" fill="currentColor" d="M271.23 72.62c-8.49-.69-15.23-7.31-15.23-15.83V24.73c0-9.11 7.67-16.78 16.77-16.17C401.92 17.18 504 124.67 504 256a246 246 0 0 1-25 108.24c-4 8.17-14.37 11-22.26 6.45l-27.84-15.9c-7.41-4.23-9.83-13.35-6.2-21.07A182.53 182.53 0 0 0 440 256c0-96.49-74.27-175.63-168.77-183.38z"></path></g></svg>
            </i>
            <span class="inline-block ml-0.5 mr-0.25">Unpacking cards</span>
            (<span class="unpack-progress inline-block font-success-700">0%</span>)
        </p>
    </div>
    <script type="module">
        import {html, render} from 'https://unpkg.com/lit-html?module'
        const statusContainer = document.body.querySelector(".status-tracker");
        const downloadProgress = document.body.querySelector(".download-progress");
        const unpackProgress = document.body.querySelector(".unpack-progress");
        const downloadTracker = document.body.querySelector(".download-tracker");
        const unpackTracker = document.body.querySelector(".unpack-tracker");
        const worker = new Worker("/ndjson-3/idb.js");
        let downloadTicks = 0;
        let unpackTicks = 0;
        let workerStarted = false;
        worker.onmessage = (e) => {
            const { type, data, uid } = e.data;
            switch (type){
                case "response":
                    if (data < 310000 && !workerStarted){
                        downloadTracker.style.display = "flex";
                        unpackTracker.style.display = "flex";
                        workerStarted = true;
                        worker.postMessage({
                            type: "ingest",
                            data: {
                                route: "/data.ndjson",
                                table: "cards",
                            }
                        });
                    } else if (data === 310000){
                        window.onbeforeunload = ()=>{};
                        statusContainer.remove();
                    }
                    break;
                case "download-tick":
                    downloadTicks++;
                    downloadProgress.innerHTML = `${Math.floor(downloadTicks / 310000 * 100)}%`;
                    break;
                case "unpack-tick":
                    unpackTicks++;
                    unpackProgress.innerHTML = `${Math.floor(unpackTicks / 310000 * 100)}%`;
                    break;
                case "download-finished":
                    setTimeout(()=>{
                        downloadTracker.remove();
                    }, 3000);
                    break;
                case "ingest-finished":
                    setTimeout(()=>{
                        statusContainer.remove();
                    }, 3000);
                    window.onbeforeunload = ()=>{};
                    break;
                case "ready":
                    worker.postMessage({
                        type: "count",
                        data: {
                            table: "cards",
                            query: null,
                            key: null,
                        }
                    });
                    break;
                default:
                    break;
            }
        }
        document.onkeydown = (event) => {
            if (event instanceof KeyboardEvent) {
                const key = event.key.toLowerCase();
                if (key === "f5") {
                    event.returnValue = false;
                    return false;
                }
                else if (key === "r" && (event.ctrlKey || event.metaKey)) {
                    event.returnValue = false;
                    return false;
                }
            }
        };
        window.onbeforeunload = confirmExit;
        function confirmExit(e) {
            const msg = "You have attempted to leave this page before the the application has finished installing. If you leave all progress wil be lost. Are you sure you want to leave?";
            e.returnValue = msg;
            return msg;
        }
    </script>
</body>
</html>